name: GitHub 이슈 수정 시 Jira Task 자동 반영

on:
  issues:
    types: [edited]

permissions:
  issues: write

jobs:
  sync-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Jira 로그인
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      # GitHub CLI 설치 (gh issue view 사용을 위해)
      - name: GitHub CLI 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      # GitHub 이슈 댓글에서 Jira 이슈 키 추출 (예: DP-123)
      - name: Jira 이슈 키 추출
        id: get-jira-key
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          OWNER=${{ github.repository_owner }}
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          JIRA_KEY=$(gh issue view "$ISSUE_NUM" --repo "$OWNER/$REPO" --json comments -q '.comments[].body' | grep -oE '[A-Z]+-[0-9]+' | head -n 1 || echo "")
          echo "JIRA_ISSUE=$JIRA_KEY" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 이슈 본문에서 epic/start/due 추출
      - name: Epic 및 일정 정보 추출
        run: |
          echo "EPIC_KEY=$(echo '${{ github.event.issue.body }}' | grep -oE 'epic: [A-Z]+-[0-9]+' | awk '{print $2}')" >> $GITHUB_ENV
          echo "START_DATE=$(echo '${{ github.event.issue.body }}' | grep -oE 'start: [0-9]{4}-[0-9]{2}-[0-9]{2}' | awk '{print $2}')" >> $GITHUB_ENV
          echo "DUE_DATE=$(echo '${{ github.event.issue.body }}' | grep -oE 'due: [0-9]{4}-[0-9]{2}-[0-9]{2}' | awk '{print $2}')" >> $GITHUB_ENV

      # Jira 이슈 수정
      - name: Jira Task 내용 동기화
        uses: atlassian/gajira-edit@v3
        if: env.JIRA_ISSUE != ''
        with:
          issue: ${{ env.JIRA_ISSUE }}
          fields: |
            {
              "summary": "${{ github.event.issue.title }}",
              "description": "🔄 GitHub Issue 동기화 내용:\n\n${{ github.event.issue.body }}",
              "customfield_10014": "${{ env.EPIC_KEY }}",
              "customfield_10015": "${{ env.START_DATE }}",
              "duedate": "${{ env.DUE_DATE }}"
            }

      - name: 코멘트로 동기화 알림 (옵션)
        uses: actions/github-script@v7
        if: env.JIRA_ISSUE != ''
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ Jira 이슈 \`${{ env.JIRA_ISSUE }}\`가 GitHub 이슈 수정 내용을 기반으로 업데이트되었습니다.`
            })
