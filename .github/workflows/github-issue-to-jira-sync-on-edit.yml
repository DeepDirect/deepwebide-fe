name: GitHub ì´ìŠˆ ìˆ˜ì • ì‹œ Jira Task ìë™ ë°˜ì˜

on:
  issues:
    types: [edited]

permissions:
  issues: write

jobs:
  sync-jira:
    runs-on: ubuntu-latest
    steps:
      - name: GitHub CLI ë° jq ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      # Jira ì´ìŠˆ í‚¤ ì¶”ì¶œ (GitHub ì´ìŠˆ ì½”ë©˜íŠ¸ì—ì„œ DP-123 í˜•íƒœë¡œ ì¶”ì¶œ)
      - name: Jira ì´ìŠˆ í‚¤ ì¶”ì¶œ
        id: get-jira-key
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}
          OWNER=${{ github.repository_owner }}
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          JIRA_KEY=$(gh issue view "$ISSUE_NUM" --repo "$OWNER/$REPO" --json comments -q '.comments[].body' | grep -oE '[A-Z]+-[0-9]+' | head -n 1 || echo "")
          echo "JIRA_ISSUE=$JIRA_KEY" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Epic/Start/Due ì •ë³´ ì¶”ì¶œ
      - name: Epic ë° ì¼ì • ì •ë³´ ì¶”ì¶œ
        run: |
          echo "EPIC_KEY=$(echo '${{ github.event.issue.body }}' | grep -oE 'epic: [A-Z]+-[0-9]+' | awk '{print $2}')" >> $GITHUB_ENV
          echo "START_DATE=$(echo '${{ github.event.issue.body }}' | grep -oE 'start: [0-9]{4}-[0-9]{2}-[0-9]{2}' | awk '{print $2}')" >> $GITHUB_ENV
          echo "DUE_DATE=$(echo '${{ github.event.issue.body }}' | grep -oE 'due: [0-9]{4}-[0-9]{2}-[0-9]{2}' | awk '{print $2}')" >> $GITHUB_ENV

      # Base64 ì¸ì½”ë”©ìœ¼ë¡œ ì¸ì¦ í—¤ë” ìƒì„±
      - name: ì¸ì¦ í—¤ë” ìƒì„± (Base64 ì¸ì½”ë”©)
        run: |
          AUTH=$(echo -n "${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }}" | base64 | tr -d '\n')
          echo "JIRA_AUTH=Basic $AUTH" >> $GITHUB_ENV

      # Jira Task ì—…ë°ì´íŠ¸ (with jq)
      - name: Jira Task ë‚´ìš© ë™ê¸°í™”
        if: env.JIRA_ISSUE != ''
        run: |
          SUMMARY="${{ github.event.issue.title }}"
          DESCRIPTION="ğŸ”„ GitHub Issue ë™ê¸°í™” ë‚´ìš©:\n\n${{ github.event.issue.body }}"

          jq -n \
            --arg summary "$SUMMARY" \
            --arg description "$DESCRIPTION" \
            --arg epic "${{ env.EPIC_KEY }}" \
            --arg start "${{ env.START_DATE }}" \
            --arg due "${{ env.DUE_DATE }}" \
            '{
              fields: {
                summary: $summary,
                description: $description,
                customfield_10014: $epic,
                customfield_10015: $start,
                duedate: $due
              }
            }' > payload.json

          echo "== ìƒì„±ëœ ìš”ì²­ ë°”ë”” =="
          cat payload.json

          curl -X PUT \
            --url "${{ secrets.JIRA_BASE_URL }}/rest/api/3/issue/${{ env.JIRA_ISSUE }}" \
            -H "Authorization: $JIRA_AUTH" \
            -H "Content-Type: application/json" \
            -d @payload.json

      # ì½”ë©˜íŠ¸ë¡œ ë™ê¸°í™” ì•Œë¦¼
      - name: ì½”ë©˜íŠ¸ë¡œ ë™ê¸°í™” ê²°ê³¼ ë‚¨ê¸°ê¸°
        uses: actions/github-script@v7
        if: env.JIRA_ISSUE != ''
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
