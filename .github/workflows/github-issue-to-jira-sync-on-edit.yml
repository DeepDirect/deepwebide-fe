name: Github 이슈 수정 시 Jira Task 자동 갱신

on:
  issues:
    types: [edited]

permissions:
  issues: write

jobs:
  update-jira-task:
    runs-on: ubuntu-latest
    steps:
      - name: Jira 필드 정보 추출
        id: extract_info
        run: |
          echo "EPIC_KEY=$(echo '${{ github.event.issue.body }}' | grep -oE 'epic: [A-Z]+-[0-9]+' | awk '{print $2}')" >> $GITHUB_ENV
          echo "START_DATE=$(echo '${{ github.event.issue.body }}' | grep -oE 'start: [0-9]{4}-[0-9]{2}-[0-9]{2}' | awk '{print $2}')" >> $GITHUB_ENV
          echo "DUE_DATE=$(echo '${{ github.event.issue.body }}' | grep -oE 'due: [0-9]{4}-[0-9]{2}-[0-9]{2}' | awk '{print $2}')" >> $GITHUB_ENV

      - name: Github 이슈 코멘트에서 Jira 키 추출
        id: extract_jira_key
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            const jiraKeyRegex = /Jira 이슈가 생성되었습니다:[^[]*\[([A-Z]+-\d+)\]/;
            let jiraKey = null;
            for (const comment of comments.data.reverse()) {
              const match = jiraKeyRegex.exec(comment.body);
              if (match) {
                jiraKey = match[1];
                break;
              }
            }
            if (!jiraKey) throw new Error("Jira 이슈키를 찾을 수 없습니다.");
            core.setOutput("jiraKey", jiraKey);

      - name: Jira Task 필드 수정 (에픽/일정)
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_ISSUE_KEY: ${{ steps.extract_jira_key.outputs.jiraKey }}
          EPIC_KEY: ${{ env.EPIC_KEY }}
          START_DATE: ${{ env.START_DATE }}
          DUE_DATE: ${{ env.DUE_DATE }}
        run: |
          echo "Jira Issue Key: $JIRA_ISSUE_KEY"
          curl -X PUT \
            -u "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --url "${JIRA_BASE_URL}/rest/api/2/issue/${JIRA_ISSUE_KEY}" \
            -d '{
              "fields": {
                "customfield_10014": "'"${EPIC_KEY}"'",
                "customfield_10015": "'"${START_DATE}"'",
                "duedate": "'"${DUE_DATE}"'"
              }
            }'

      - name: Github 이슈에 수정 결과 안내 코멘트
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `♻️ **Jira Task 일정/에픽 정보가 업데이트 되었습니다.**`
            })
